---
title: "25 Rewriting R code in C++"
output: html_document
date: "2023-09-11"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 25 Rewriting R code in C++
## 25.1 Introduction

```{r}
library(Rcpp)
```

## 25.2 Getting started with C++

```{r}
cppFunction('int add(int x, int y, int z) {
  int sum = x + y + z;
  return sum;
}')

add

add(1, 2, 3)
```

### 25.2.1 No inputs, scalar output

```{r}
one <- function() 1L
```

```
int one() {
  return 1;
}
```

```{r}
cppFunction('int one() {
  return 1;
}')
```

### 25.2.2 Scalar input, scalar output

```{r}
signR <- function(x) {
  if (x > 0) {
    1
  } else if (x == 0) {
    0
  } else {
    -1
  }
}

cppFunction('int signC(int x) {
  if (x > 0) {
    return 1;
  } else if (x == 0) {
    return 0;
  } else {
    return -1;
  }
}')
```

### 25.2.3 Vector input, scalar output

```{r}
sumR <- function(x) {
  total <- 0
  for (i in seq_along(x)) {
    total <- total + x[i]
  }
  total
}
```

```{r}
cppFunction('double sumC(NumericVector x) {
  int n = x.size();
  double total = 0;
  for(int i = 0; i < n; ++i) {
    total += x[i];
  }
  return total;
}')
```

```{r}
x <- runif(1e3)
bench::mark(
  sum(x),
  sumC(x),
  sumR(x)
)[1:6]
```

### 25.2.4 Vector input, vector output

```{r}
pdistR <- function(x, ys) {
  sqrt((x - ys) ^ 2)
}
```


```{r}
cppFunction('NumericVector pdistC(double x, NumericVector ys) {
  int n = ys.size();
  NumericVector out(n);

  for(int i = 0; i < n; ++i) {
    out[i] = sqrt(pow(ys[i] - x, 2.0));
  }
  return out;
}')
```

```{r}
y <- runif(1e6)
bench::mark(
  pdistR(0.5, y),
  pdistC(0.5, y)
)[1:6]
```

### 25.2.5 Using sourceCpp

```
#include <Rcpp.h>
using namespace Rcpp;
```

```
// [[Rcpp::export]]
```

```
/*** R
# This is R code
*/
```

```{r}
sourceCpp("cpp_example.cpp")
```

### 25.2.6 Exercises

1. With the basics of C++ in hand, itâ€™s now a great time to practice by reading and writing some simple C++ functions. For each of the following functions, read the code and figure out what the corresponding base R function is. You might not understand every part of the code yet, but you should be able to figure out the basics of what the function does.

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double f1(NumericVector x) {
  int n = x.size();
  double y = 0;

  for(int i = 0; i < n; ++i) {
    y += x[i] / n;
  }
  return y;
}
```

```{r}
x <- c(1,2,3)
mean(x)
f1(x)
```
#### mean()

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector f2(NumericVector x) {
  int n = x.size();
  NumericVector out(n);

  out[0] = x[0];
  for(int i = 1; i < n; ++i) {
    out[i] = out[i - 1] + x[i];
  }
  return out;
}
```

```{r}
x <- c(1,2,3,4)
cumsum(x)
f2(x)
```
#### cumsum()

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
bool f3(LogicalVector x) {
  int n = x.size();

  for(int i = 0; i < n; ++i) {
    if (x[i]) return true;
  }
  return false;
}
```

```{r}
x <- c(T,T,F)
any(x)
f3(x)
```
#### any()

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
int f4(Function pred, List x) {
  int n = x.size();

  for(int i = 0; i < n; ++i) {
    LogicalVector res = pred(x[i]);
    if (res[0]) return i + 1;
  }
  return 0;
}
```

```{r}
f4(sample, c(1,2))
Position(sample, c(1,2))
```
#### Position()

```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector f5(NumericVector x, NumericVector y) {
  int n = std::max(x.size(), y.size());
  NumericVector x1 = rep_len(x, n);
  NumericVector y1 = rep_len(y, n);

  NumericVector out(n);

  for (int i = 0; i < n; ++i) {
    out[i] = std::min(x1[i], y1[i]);
  }

  return out;
}
```

```{r}
x <- c(1,2,3,4,5)
y <- c(11,12,13,14,15)
f5(x,y)
pmin(x,y)
```
#### pmin()

2. To practice your function writing skills, convert the following functions into C++. For now, assume the inputs have no missing values.

`all()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
bool allC(LogicalVector x) {
  int n = x.size();
  
  for(int i = 0; i < n; i++){
    if(!x[i]) return false;
  }
  return true;
}
```

```{r}
x <- c(T,T,F)
y <- c(T,T,T)

all(x)
allC(x)
all(y)
allC(y)
```

`cumprod()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector cumprodC(NumericVector x) {
  int n = x.size();
  NumericVector out(n);

  out[0] = x[0];
  for(int i = 1; i < n; ++i) {
    out[i] = out[i - 1] * x[i];
  }
  return out;
}
```

```{r}
x <- c(1,2,3,4)
cumprod(x)
cumprodC(x)
```

`cummin()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector cumminC(NumericVector x) {
  int n = x.size();
  NumericVector out(n);

  out[0] = x[0];
  for(int i = 1; i < n; ++i) {
      out[i] = std::min(x[i], out[i-1]);
  }
  return out;
}
```

```{r}
x <- c(6432,3462,234,6,1325235,1231,23525,2)
cummin(x)
cumminC(x)
```


`cummax()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector cummaxC(NumericVector x) {
  int n = x.size();
  NumericVector out(n);

  out[0] = x[0];
  for(int i = 1; i < n; ++i) {
      out[i] = std::max(x[i], out[i-1]);
  }
  return out;
}
```

```{r}
x <- c(6432,3462,234,6,1325235,1231,23525,2)
cummax(x)
cummaxC(x)
```

`diff()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector diffC(NumericVector x, int y) {
  int n = x.size() - y;
  NumericVector out(n);

  for(int i = 0; i < n; ++i) {
      out[i] = x[i + y] - x[i];
  }
  return out;
}


```

```{r}
x <- c(10,5,1,5,2,6)
diff(x,1)
diffC(x,1)
diff(x,2)
diffC(x,2)
```


`range()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
NumericVector rangeC(NumericVector x) {
  int n = x.size();
  NumericVector out(2);
  
  out[0] = x[0];
  out[1] = x[0];
  
  for(int i = 0; i < n; ++i) {
      if(x[i] < out[0]) out[0] = x[i];
      if(x[i] > out[1]) out[1] = x[i];
  }
  
  return out;
}
```

```{r}
x <- c(234,12,63)
range(x)
rangeC(x)
```

`var()`
```{Rcpp}
#include <Rcpp.h>
using namespace Rcpp;

// [[Rcpp::export]]
double varC(NumericVector x){
  int n = x.size();
  double meanx = 0;
  
  for(int i = 0; i < n; i++){
    meanx += x[i] / n;
    }

  double var = 0;
  
  for(int i = 0; i < n; i++){
    var += pow(x[i] - meanx, 2);
    }
  return var / (n -1 );
}
```

```{r}
var(1:10)
varC(1:10)
```

